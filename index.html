<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<title>Faster Browser Code</title>
	</head>
	<body>
		<h1>Faster Browser Code</h1>

		<h2>Benchmarks:</h2>

		<p>
			<button id="start">Start</button>
		</p>

		<ul>
			<li><a href="tests/js_pure">JavaScript - Pure</a> <span id="time_js_pure"></span></li>
			<li><a href="tests/js_webworker">JavaScript - WebWorker</a> <span id="time_js_webworker"></span></li>
		</ul>

		<h2>TODO:</h2>
		<ul>
			<li>JavaScript - SIMD</li>
			<li>ASM.js</li>
			<li>Emscripten - C++</li>
			<li>Duetto</li>
			<li>WebAssembly - C++</li>
			<li>Dart</li>
			<li>TypeScript</li>
			<li>CoffeeScript</li>
			<li>Nacl</li>
			<li>Pnacl</li>
			<li>Hax</li>
			<li>GLSL</li>
			<li>C# - JSIL</li>
			<li>Go - gopherjs</li>
		</ul>
	</body>
	<script>
	function fibonacci(n) {
		if (n < 2) {
			return n;
		}
		return fibonacci(n - 2) + fibonacci(n - 1);
	}

	function benchmarkJSPure(cb) {
		var start_time = new Date().getTime();
		var result = fibonacci(43);
		var end_time = new Date().getTime();
		var diff_time = end_time - start_time;
		cb(diff_time, result);
	}

	function benchmarkJSWebWorker(cb) {
		var worker = new Worker('worker.js');
		worker.onmessage = function(e) {
			switch (e.data.action) {
				case 'end':
					var start_time = e.data.start_time;
					var result = e.data.result;
					var end_time = e.data.end_time;
					var diff_time = end_time - start_time;
					cb(diff_time, result);
					worker.terminate();
					break;
			}
		};

		var message = {
			action: 'start'
		};
		worker.postMessage(message);
	}

	var g_benchmarks = [
		{'time_js_pure' : benchmarkJSPure},
		{'time_js_webworker' : benchmarkJSWebWorker}
	];

	function startBenchmarks() {
		var nextBenchmark = function(i) {
			if (i >= g_benchmarks.length) {
				return;
			}

			var bench_element = Object.keys(g_benchmarks[i])[0];
			var bench_cb = g_benchmarks[i][bench_element];
			var time_span = document.querySelector('#' + bench_element);
			time_span.innerHTML = 'Running ...';

			setTimeout(function() {
				bench_cb(function(diff_time, result) {
					time_span.innerHTML = diff_time + 'ms';
					nextBenchmark(i + 1);
				});
			}, 100);
		};
		nextBenchmark(0);
	}

	document.querySelector('#start').addEventListener('click', function() {
		startBenchmarks();
	}, false);
	</script>
</html>
